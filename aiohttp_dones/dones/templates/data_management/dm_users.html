{% extends "data_management/dm_layout.html" %} {% set current_tab = 'users' %}
{% block inner_content %}
<style>
  .table .btn {
    height: 27px;
  }

  .search-field {
    max-width: 150px;
    direction: ltr;
    text-align: left;
    margin: 0 auto 0 5px;
  }

  /* .dropbtn {
    background-color: #4caf50;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
  }

  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
    z-index: 1;
  }

  .dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }

  .dropdown-content a:hover {
    background-color: #f1f1f1;
  } */

  /* .dropdown:hover .dropdown-content {
    display: block;
  }

  .dropdown:hover .dropbtn {
    background-color: #3e8e41;
  } */
</style>
<form action="/get-user-by-mobile" method="GET" class="mb-3 d-flex">
  <button
    class="btn btn-primary btn-sm"
    type="button"
    data-toggle="collapse"
    data-target="#collapse"
  >
    ایجاد کاربر جدید
  </button>
  <!-- <input
    class="form-control search-field"
    name="mobile"
    placeholder="09xxxxxxxxx"
    type="text"
    maxlength="11"
  />
  <button class="btn btn-success btn-sm">جستجو</button> -->
</form>

<div class="collapse mb-3 {% if user_id %}d-block{% endif %}" id="collapse">
  <form
    action="{% if user_id  %}/dm-users/{{ user_id }}{% else %}/dm-users{% endif %}"
    method="POST"
  >
    <div class="form-row">
      <div class="form-group col-md-3">
        <label><span style="color: red"> * </span>نام و نام خانوادگی</label>
        <input
          id="f1"
          onkeyup="success()"
          class="form-control"
          type="text"
          placeholder="نام و نام خانوادگی"
          name="full_name"
          value="{% if user_id  %}{{update_user.full_name}}{% endif %}"
        />
      </div>
      <div class="form-group col-md-3">
        <label><span style="color: red"> * </span>شماره موبایل</label>
        <input
          id="f2"
          onkeyup="success()"
          minlength="11"
          maxlength="11"
          class="form-control"
          type="text"
          placeholder="شماره موبایل"
          name="mobile"
          value="{% if user_id  %}{{update_user.mobile}}{% endif %}"
        />
      </div>
      <!-- <div class="form-group col-md-3">
        <label><span style="color: red"> * </span>کد ملی</label>
        <input
          id="f3"
          onkeyup="success()"
          minlength="10"
          maxlength="10"
          class="form-control"
          type="text"
          placeholder="کد ملی"
          name="national_id"
          value="{% if user_id and update_user.national_id %}{{update_user.national_id}}{% endif %}"
        />
      </div> -->
      <div class="form-group col-md-3 {% if user_id %}d-none{% endif %}">
        <label><span style="color: red"> * </span>رمزعبور</label>
        <input
          id="f4"
          onkeyup="success()"
          minlength="6"
          class="form-control"
          type="password"
          placeholder="رمزعبور"
          name="password"
          value="{% if user_id  %}{{update_user.password}}{% endif %}"
        />
      </div>
      <div class="form-group col-md-3 mt-4">
        <label><span style="color: red"> * </span>نوع کاربر</label>

        <select id="f5" oninput="success()" name="user_type">
          <option value="2">عادی</option>
          <option value="-2">ادمین</option>
          <option value="-1">سازمان/گروه</option>
        </select>
      </div>
      <!-- <input
          id="f5"
          onkeyup="success()"
          class="form-control"
          type="text"
          placeholder="نوع کاربر"
          name="user_type"
          value="{% if user_id  %}{{update_user.user_type}}{% endif %}"
        /> -->

      <!-- <div  onclick="dropd()" class="dropdown">
          <input class="dropbtn">Dropdown</input>
          <div  id="ddContent" class="dropdown-content">
            <a href="#">Link 1</a>
            <a href="#">Link 2</a>
            <a href="#">Link 3</a>
          </div>
        </div> -->

      <!-- <div class="dropdown">
          <button
            type="button"
            class="btn dropdown-toggle"
            data-bs-toggle="dropdown"
          >
            نوع کاربر
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">ادمین</a></li>
            <li><a class="dropdown-item" href="#">سازمان/گروه</a></li>
            <li><a class="dropdown-item" href="#">عادی</a></li>
          </ul>
        </div> -->

      <div class="form-group col-md-4">
        {% if user_id %}
        <input
          rows="5"
          type="hidden"
          class="form-control"
          name="auth_key"
          value="{% if user_id  %}{{update_user.auth_key}}{% endif %}"
        />
        {% endif %}
      </div>
    </div>
    <button
      disabled
      id="submitbtn"
      class="btn btn-success dm-submit"
      type="submit"
    >
      ثبت
    </button>
  </form>
</div>
<div class="table-responsive">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>نوع کاربر</th>
        <th>نام کاربر</th>
        <th>موبایل</th>
        <!-- <th>جنسیت</th>
        <th>سن</th>
        <th>تحصیلات</th>
        <th>شغل</th>
        <th>وضعیت تاهل</th> -->
        <th>تنظیمات</th>
      </tr>
    </thead>
    {% if users %} {% for user in users %}
    <ul id="paginated-list" data-current-page="1" aria-live="polite">
      <tr class="paginated-cases">
        <td>{{(start_index) - (loop.index)}}</td>
        <td>
          {% if user.user_type == -2 %}ادمین{% elif user.user_type == -1
          %}سازمان/گروه{% else %}عادی{% endif %}
        </td>
        <td>{{user.full_name}}</td>
        <td>{{user.mobile}}</td>
        <td>
          <a class="btn btn-success btn-sm" href="/dm-users/{{user.id}}"
            ><i class="far fa-cog"></i
          ></a>
        </td>
      </tr>
    </ul>
    <!-- <div id="comments_container" class="relative-wrapper" data-id="{{user}}">
      {% include 'spinner.html' %}
    </div>
    <nav id="pagination" class="collapse"></nav> -->
    {% endfor %} {% endif %}
  </table>
  {% if page_count > 0 %}

  <!-- <nav class="pagination-container">
    <button
      style="outline: none"
      class="pagination-button"
      id="prev-button"
      aria-label="Previous page"
      title="Previous page"
    >
      &lt;
    </button>
    <div id="pagination-numbers"></div>
    <button
      style="outline: none"
      class="pagination-button"
      id="next-button"
      aria-label="Next page"
      title="Next page"
    >
      &gt;
    </button>
  </nav> -->

  <!-- <nav class="page d-flex justify-content-center" aria-label="Page navigation">
    <ul class="pagination">
      {% set number = page_count %} {% set page_number = page_number %} {% set
      min_page = page_number - 2 %} {% set max_page = page_number + 2 %} {% if
      min_page < 1 %}{% set min_page=1 %}{% endif %} {% set max_page=min_page +
      3 %} {% if max_page>number %}{% set max_page = number %}{% endif %} {% set
      min_page = max_page - 3 %} {% if min_page < 1 %}{% set min_page=1 %}{%
      endif %}
      <li class="page-item {% if page_number == 1 %}disabled{% endif %}">
        <a class="page-link" href="/dm-users?page_number=1" aria-label="first"
          >اولین</a
        >
      </li>
      <li class="page-item {% if page_number == 1 %}disabled{% endif %}">
        <a
          class="page-link"
          href="/dm-users?page_number={{page_number-1}}"
          aria-label="Previous"
          >قبلی</a
        >
      </li>
      {%- for page in range(1, number) %}
      <li class="page-item {% if page == page_number %}activing{% endif %}">
        <a class="page-link" href="/dm-users?page_number={{page}}">{{page}}</a>
      </li>
      {% endfor %}
      <li class="page-item {% if page_number == max_page %}disabled{% endif %}">
        <a
          class="page-link"
          href="/dm-users?page_number={{page_number+1}}"
          aria-label="Next"
          >بعدی</a
        >
      </li>
      <li class="page-item {% if page_number == number %}disabled{% endif %}">
        <a
          class="page-link"
          href="/dm-users?page_number={{number}}"
          aria-label="last"
          >آخرین</a
        >
      </li>
    </ul>
  </nav> -->

  {% endif %}
</div>
{% endblock %} {% block scripts %}

<script>
  $(function () {
    let pageNumber = 1;
    $("#pagination").on("click", ".page-item", function () {
      if ($(this).hasClass("active") || $(this).hasClass("disabled")) return;
      $("#comments_container")
        .empty()
        .append(
          $.parseHTML(
            '<div class="busy-overlay"><div class="spinner"></div></div>'
          )
        );
      const clickedData = $(this).data("page");
      targetPage =
        clickedData !== "prev" && clickedData !== "next"
          ? clickedData
          : clickedData === "prev"
          ? pageNumber - 1
          : pageNumber + 1;
      loadComments(targetPage);
    });
    const sectionId = $("#comments_container").data("id");
    const structure = [
      {
        template: "comments_dynamic.html",
        data: "all_comments",
        id: "comments_container",
      },
    ];
    const loadComments = function (targetPage) {
      loadJson(
        `/json-get-comments-and-courses_news-by-section-id/${sectionId}?page_number=${targetPage}`,
        structure,
        function (pageStatus) {
          current_page = pageStatus.current_page;
          pageNumber = current_page;
          pages_count = pageStatus.pages_count;
          $("#pagination").empty().addClass("collapse");
          if (pages_count > 1) {
            let pagination = '<ul class="pagination justify-content-center">';
            pagination += `<li class="page-item ${
              current_page === 1 ? "disabled" : ""
            }" data-page="prev"><span class="page-link">قبلی</span></li>`;
            const dummy = [...Array(pages_count).keys()].map(
              (item) =>
                (pagination += `<li class="page-item ${
                  current_page === item + 1 ? "active" : ""
                }" data-page="${item + 1}"><span class="page-link">${
                  item + 1
                }</span></li>`)
            );
            pagination += `<li class="page-item ${
              current_page === pages_count ? "disabled" : ""
            }" data-page="next"><span class="page-link">بعدی</span></li>`;
            $("#pagination")
              .append($.parseHTML(pagination))
              .removeClass("collapse");
          }
        }
      );
    };
    loadComments(1);
  });

  const paginationNumbers = document.getElementById("pagination-numbers");
  const paginatedList = document.getElementById("paginated-list");
  const listItems = paginatedList.getElementsByClassName("paginated-cases");
  const nextButton = document.getElementById("next-button");
  const prevButton = document.getElementById("prev-button");
  const paginationLimit = 2;
  const pageCount = Math.ceil(listItems.length / paginationLimit);
  let currentPage;
  const appendPageNumber = (index) => {
    const pageNumber = document.createElement("button");
    pageNumber.className = "pagination-number";
    pageNumber.innerHTML = index;
    pageNumber.setAttribute("page-index", index);
    pageNumber.setAttribute("aria-label", "Page " + index);
    paginationNumbers.appendChild(pageNumber);
  };

  const getPaginationNumbers = () => {
    for (let i = 1; i <= pageCount; i++) {
      appendPageNumber(i);
    }
  };
  window.addEventListener("load", () => {
    getPaginationNumbers();
    setCurrentPage(1);

    prevButton.addEventListener("click", () => {
      setCurrentPage(currentPage - 1);
    });

    nextButton.addEventListener("click", () => {
      setCurrentPage(currentPage + 1);
    });

    document.querySelectorAll(".pagination-number").forEach((button) => {
      const pageIndex = Number(button.getAttribute("page-index"));

      if (pageIndex) {
        button.addEventListener("click", () => {
          setCurrentPage(pageIndex);
        });
      }
    });
  });
  const setCurrentPage = (pageNum) => {
    currentPage = pageNum;

    handleActivePageNumber();
    handlePageButtonsStatus();

    const prevRange = (pageNum - 1) * paginationLimit;
    const currRange = pageNum * paginationLimit;

    listItems.forEach((item, index) => {
      item.classList.add("hidden");
      if (index >= prevRange && index < currRange) {
        item.classList.remove("hidden");
      }
    });
  };
  const handleActivePageNumber = () => {
    document.querySelectorAll(".pagination-number").forEach((button) => {
      button.classList.remove("active");

      const pageIndex = Number(button.getAttribute("page-index"));
      if (pageIndex == currentPage) {
        button.classList.add("active");
      }
    });
  };
  const disableButton = (button) => {
    button.classList.add("disabled");
    button.setAttribute("disabled", true);
  };

  const enableButton = (button) => {
    button.classList.remove("disabled");
    button.removeAttribute("disabled");
  };

  const handlePageButtonsStatus = () => {
    if (currentPage === 1) {
      disableButton(prevButton);
    } else {
      enableButton(prevButton);
    }

    if (pageCount === currentPage) {
      disableButton(nextButton);
    } else {
      enableButton(nextButton);
    }
  };
  function success() {
    if (
      document.getElementById("f1").value === "" ||
      document.getElementById("f2").value === "" ||
      // document.getElementById("f3").value === "" ||
      document.getElementById("f4").value === "" ||
      document.getElementById("f4").value === "" ||
      document.getElementById("f5").value === ""
    ) {
      document.getElementById("submitbtn").disabled = true;
    } else {
      document.getElementById("submitbtn").disabled = false;
    }
  }
  function dropd() {
    let x = document.getElementById("ddContent");
    if ((x.style.display = "inline-block")) {
      x.style.display = "block";
    } else {
      x.style.display = "inline-block";
    }
  }
</script>

{% endblock %}
